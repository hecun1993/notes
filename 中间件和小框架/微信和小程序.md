### 微信小程序支付过程

1. 当服务器返回给客户端订单创建成功之后, 小程序会调用服务器的支付接口
2. 服务器的支付接口会生成一个预订单, 这个预订单的唯一标识, 比如用户的openid, 或者订单号, 将作为参数, 请求微信服务器
3. 微信服务器会返回一些支付参数
4. 服务器把这些支付参数返回给小程序, 小程序携带支付参数, 自己访问微信服务器发起支付
5. 微信服务器会立刻通知小程序是否支付成功
6. 微信服务器还会**[异步的不断的]**通知服务器支付结果(成功/失败), 直到服务器发送给微信一个结果通知, 说我已经收到支付结果了, 然后微信服务器才不返回支付结果给服务器.



### 登录与令牌(Token)

> 在restful风格的编程中，不存在登录的概念。所有的登录都是依靠令牌（token）来实现的。

* 登录 == 用户去拿令牌（token）
* 用户每次访问某一个api，都要携带之前获取到的令牌，来让服务器判断，它是否有权限调用这个接口。

* 小程序会为每一个用户生成一个code，然后携带code访问服务器的getToken接口。
* getToken接口携带code，访问微信服务器，微信服务器会返回openid，也就是身份的唯一标示。我们需要把openid存在数据库中。
* 我们需要把openid传给客户端，让它每次访问接口时，都携带openid。
* 但是openid不建议传给客户端（机密数据，不能设置过期时间），所以，我们会生成令牌Token，客户端每次访问时携带这个令牌，每一个Token对应一个openid，从而可以找到openid了。
* 然后把Token返回给客户端，同时给Token设置过期时间。
* 要把openid存在数据库，但令牌Token可以存在缓存中，我们只要验证Token是否合法即可，加快访问速度。